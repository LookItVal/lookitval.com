 <template>
  <div>
    <svg class="w-full h-full" viewBox="0 0 533.7909 148.63465" xmlns="http://www.w3.org/2000/svg" preserveAspectRatio="xMidYMid meet">
      <path 
        ref="barbsPathUnloaded"
        d="m 529.50245,74.701458 c 0,-5.99344 -2.80863,-11.84121 -8.34881,-17.38139 -19.45463,-19.45463 -69.92014,-32.06447 -98.27017,-37.84931 l -2.2493,-0.45891 -34.49692,26.73712 10.55145,-31.083 -5.88737,-0.90792 C 352.78161,7.9003678 311.70578,4.6745478 275.1427,4.6745478 c -6.70973,-7e-4 -13.42371,0.1089 -19.95596,0.32386 l -1.35341,0.0438 -74.0468,46.6294502 28.78773,-43.2240302 -11.23876,1.7550402 c -6.627,1.03521 -13.09491,2.22668 -19.22552,3.5419 l -1.11441,0.239 -51.92426,40.24286 9.37199,-27.60827 -11.36603,6.36679 c -15.03875,8.42447 -24.887333,30.04125 -29.147651,35.46582 l -77.138986,3.5e-4 c -6.9034831,3.6e-4 -12.4995271,2.79838 -12.5002341,6.25012 7.07e-4,1.7257 1.399365,3.2884 3.661399,4.41942 2.2620351,1.13102 5.3874471,1.83034 8.8388351,1.8307 h 77.105752 c 2.127684,2.71493 5.666047,16.89154 10.606605,21.832092 7e-4,7e-4 7e-4,7e-4 0.001,0.001 4.87055,4.87055 11.11996,9.45685 18.57216,13.63231 l 11.36603,6.36821 -9.3727,-27.610392 51.92427,40.242852 1.11369,0.23829 c 6.11648,1.31381 12.58509,2.50458 19.22624,3.54261 l 11.23875,1.75645 -28.78702,-43.224722 74.04822,46.629442 1.35411,0.0446 c 6.54852,0.21425 13.26249,0.32385 19.95597,0.32385 51.162,0 108.00844,-6.02808 155.96371,-16.53922 l 27.27523,-6.78186 0.15203,-0.0403 c 47.09048,-13.30209 70.96806,-29.002682 70.96736,-46.665502 z"
        :stroke="unloadedStrokeColorValue"
        stroke-width="0"
        stroke-linejoin="round"
        stroke-linecap="round"
        fill="none"
        stroke-dasharray="0 10000"
      />
      <path
        ref="shaftPathUnloaded"
        d="m 4.3010252,74.317141 c -0.0485,-3.5123 7.4244998,-6.1357 12.5001998,-6.2501 174.111605,0 329.565505,0.4319 499.720105,6.2623 -169.5773,3.41 -325.232,6.238 -499.720105,6.238 -5.8908,-0.5845 -12.5573998,-1.4256 -12.5001998,-6.2502 z"
        :stroke="unloadedStrokeColorValue"
        stroke-width="0"
        stroke-linejoin="round"
        stroke-linecap="round"
        fill="none"
        stroke-dasharray="0 10000"
      />

      <!-- Animated Paths -->
      <path 
        ref="barbsPathLoaded"
        d="M 4.3019 74.3173 C 4.013 71.6606 10.1117 68.2074 16.8021 68.0672 L 93.9411 68.0668 C 98.2014 62.6423 108.05 41.0255 123.0887 32.601 L 134.4548 26.2342 L 125.0828 53.8425 L 177.007 13.5996 L 178.1214 13.3606 C 184.252 12.0454 190.72 10.854 197.347 9.8187 L 208.5857 8.0637 L 179.798 51.2877 L 253.8448 4.6583 L 255.1982 4.6145 C 261.7305 4.3995 268.4444 4.2899 275.1542 4.2906 C 311.7172 4.2906 352.7931 7.5164 390.8128 13.3741 L 396.7002 14.282 L 386.1487 45.365 L 420.6456 18.6279 L 422.8949 19.0868 C 451.245 24.8717 501.7105 37.4815 521.1651 56.9361 C 526.7053 62.4763 529.5139 68.3241 529.5139 74.3175 L 529.5135 74.3171 C 529.5142 91.98 505.6366 107.6806 458.5461 120.9827 L 458.3941 121.023 L 431.1189 127.8048 C 383.1636 138.316 326.3172 144.344 275.1552 144.344 C 268.4617 144.344 261.7477 144.2344 255.1992 144.0202 L 253.8451 143.9756 L 179.7969 97.3461 L 208.5839 140.5709 L 197.3451 138.8144 C 190.704 137.7764 184.2354 136.5856 178.1189 135.2718 L 177.0052 135.0335 L 125.0809 94.7907 L 134.4536 122.4011 L 123.0876 116.0328 C 115.6354 111.8574 109.386 107.2711 104.5155 102.4005 L 104.5144 102.3995 C 99.5739 97.459 96.0355 83.2824 93.9078 80.5674 H 16.8021 C 10.3737 80.5257 4.3255 78.4397 4.3019 74.3173 Z"
        :stroke="loadedStrokeColorValue"
        stroke-width="0"
        stroke-linejoin="round"
        stroke-linecap="round"
        fill="none"
        stroke-dasharray="0 10000"
      />
      <path
        ref="shaftPathLoaded"
        d="m 4.3010252,74.317141 c -0.0485,-3.5123 7.4244998,-6.1357 12.5001998,-6.2501 174.111605,0 329.565505,0.4319 499.720105,6.2623 -169.5773,3.41 -325.232,6.238 -499.720105,6.238 -5.8908,-0.5845 -12.5573998,-1.4256 -12.5001998,-6.2502 z"
        :stroke="loadedStrokeColorValue"
        stroke-width="0"
        stroke-linejoin="round"
        stroke-linecap="round"
        fill="none"
        stroke-dasharray="0 10000"
      />
    </svg>
  </div>
 </template>

<script lang="ts" setup>
import { useConstants } from '@/composables/constants';
import { gsap } from 'gsap';


const { COLORS } = useConstants();

const props = withDefaults(defineProps<{
  unloadedStrokeColor?: keyof typeof COLORS
  loadedStrokeColor?: keyof typeof COLORS
  strokeWidth?: number
  easeFunction?: string
  progress?: number // 0 to 1
}>(), {
  unloadedStrokeColor: 'surface-100',
  loadedStrokeColor: 'mauve-500',
  strokeWidth: 5,
  easeFunction: 'power1.inOut',
  progress: 0.0
})

const unloadedStrokeColorValue = computed(() => COLORS[props.unloadedStrokeColor]);
const loadedStrokeColorValue = computed(() => COLORS[props.loadedStrokeColor]);

const barbsPathLoaded = ref<SVGPathElement>();
const shaftPathLoaded = ref<SVGPathElement>();
const barbsPathUnloaded = ref<SVGPathElement>();
const shaftPathUnloaded = ref<SVGPathElement>();

let loadingAnimationTimeline: GSAPTimeline
let entryAnimationTimeline: GSAPTimeline

onMounted(async () => {
  await nextTick();
  if (barbsPathUnloaded.value && shaftPathUnloaded.value) {
    const barbsLength = barbsPathUnloaded.value.getTotalLength();
    const shaftLength = shaftPathUnloaded.value.getTotalLength();

    gsap.set([barbsPathUnloaded.value, shaftPathUnloaded.value], {
      strokeDasharray: function(index) {
        return index === 0 ? `0 ${barbsLength}` : `0 ${shaftLength}`;
      },
      strokeWidth: 0
    });

    entryAnimationTimeline = gsap.timeline({ ease: 'linear' });

    entryAnimationTimeline.to(barbsPathUnloaded.value, {
      strokeWidth: props.strokeWidth,
      duration: 0.5
    }, 0);
    entryAnimationTimeline.to(barbsPathUnloaded.value, {
      strokeDasharray: `${barbsLength} 0`,
      duration: 1
    }, '>');

    entryAnimationTimeline.to(shaftPathUnloaded.value, {
      strokeWidth: props.strokeWidth,
      duration: 0.5
    }, 0);
    entryAnimationTimeline.to(shaftPathUnloaded.value, {
      strokeDasharray: `${shaftLength} 0`,
      duration: 1
    }, '>');
  }
  if (barbsPathLoaded.value && shaftPathLoaded.value) {
    const barbsLength = barbsPathLoaded.value.getTotalLength();
    const shaftLength = shaftPathLoaded.value.getTotalLength();

    // Set initial stroke-dasharray to hide the paths
    gsap.set([barbsPathLoaded.value, shaftPathLoaded.value], {
      strokeDasharray: function(index) {
        return index === 0 ? `0 ${barbsLength}` : `0 ${shaftLength}`;
      },
      strokeWidth: 0
    });

    // Create a timeline for the loading animation
    loadingAnimationTimeline = gsap.timeline({ paused: true, ease: props.easeFunction });

    loadingAnimationTimeline.to([barbsPathLoaded.value, shaftPathLoaded.value], {
      strokeWidth: props.strokeWidth,
      duration: 0.1
    }, 0);
    loadingAnimationTimeline.to(barbsPathLoaded.value, {
      strokeDasharray: `${barbsLength} 0`,
      duration: 5
    }, '>');

    loadingAnimationTimeline.to(shaftPathLoaded.value, {
      strokeWidth: props.strokeWidth,
      duration: 0.1
    }, 0);
    loadingAnimationTimeline.to(shaftPathLoaded.value, {
      strokeDasharray: `${shaftLength} 0`,
      duration: 5
    }, '>');
  }
});

watch(() => props.progress, (newProgress) => {
  if (loadingAnimationTimeline) {
    gsap.to(loadingAnimationTimeline, {
      progress: newProgress,
      duration: 1,
      ease: props.easeFunction
    });
  }
});

onUnmounted(() => {
  if (entryAnimationTimeline.value) {
    entryAnimationTimeline.value.kill();
    entryAnimationTimeline.value = null;
  }
  if (loadingAnimationTimeline.value) {
    loadingAnimationTimeline.value.kill();
    loadingAnimationTimeline.value = null;
  }
});
</script>